<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Shine Smile</title>
    <link rel="stylesheet" href="./assets/css/reset.css" />
    <link rel="stylesheet" href="./assets/css/style.css" />
  </head>
  <body class="header">
    <div class="container">
      <div class="header-top">
        <a href="./"
          ><img
            src="./assets/img/logo.svg"
            alt="shine smile"
            class="logo header__logo"
        /></a>
        <nav class="navbar">
          <ul class="navbar__list" id="navbar__list--pc">
            <li class="navbar__item">
              <a href="./index.html" class="navbar__link">Home</a>
            </li>
            <li class="navbar__item">
              <a href="./services.html" class="navbar__link">Services</a>
            </li>
            <li class="navbar__item">
              <a href="#!" class="navbar__link">About</a>
            </li>
            <li class="navbar__item">
              <a href="#!" class="navbar__link">Doctors</a>
            </li>
          </ul>
        </nav>
        <div class="header__action">
          <span id="userInfo" style="color: #10375c; margin-right: 20px;"></span>
          <button id="logoutBtn" class="header__action--login">Logout</button>
        </div>
      </div>

      <div class="about-content" style="margin: 60px auto; max-width: 800px;">
        <h2 class="section-heading" style="font-size: 3rem; text-align: center; margin-bottom: 40px;">
          My Dashboard
        </h2>

        <div id="loginMessage" style="display: none; background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px; text-align: center;">
          Please <a href="./login.html" style="color: #2e80ce;">login</a> to view your dashboard
        </div>

        <div id="dashboardContent" style="display: none;">
          <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="color: #2e7d32; margin-bottom: 10px;">Welcome back!</h3>
            <p id="userDetails" style="color: #10375c;"></p>
          </div>

          <div style="margin-bottom: 30px;">
            <h3 style="color: #10375c; margin-bottom: 20px;">My Appointments</h3>
            <div id="appointmentsList" style="background: #fff; border-radius: 10px; padding: 20px;">
              <div id="loadingMessage" style="text-align: center; color: #666;">Loading appointments...</div>
              <div id="noAppointments" style="display: none; text-align: center; color: #666;">
                No appointments found. <a href="./services.html" style="color: #2e80ce;">Book your first appointment</a>
              </div>
            </div>
          </div>

          <div style="text-align: center;">
            <a href="./services.html" class="btn" style="display: inline-block; margin: 0 10px;">
              Book New Appointment
            </a>
          </div>
        </div>

        <div id="message" style="margin-top: 20px; padding: 10px; border-radius: 5px; text-align: center; display: none;"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const loginMessage = document.getElementById('loginMessage');
      const dashboardContent = document.getElementById('dashboardContent');
      const userInfo = document.getElementById('userInfo');
      const userDetails = document.getElementById('userDetails');
      const appointmentsList = document.getElementById('appointmentsList');
      const loadingMessage = document.getElementById('loadingMessage');
      const noAppointments = document.getElementById('noAppointments');
      const logoutBtn = document.getElementById('logoutBtn');
      const messageDiv = document.getElementById('message');

      // Check if user is logged in
      if (!token) {
        loginMessage.style.display = 'block';
        dashboardContent.style.display = 'none';
      } else {
        loginMessage.style.display = 'none';
        dashboardContent.style.display = 'block';
        
        // Display user info
        userInfo.textContent = `Welcome, ${user.fullName || user.username || 'User'}`;
        userDetails.textContent = `Email: ${user.email || 'N/A'}`;
        
        // Load appointments
        loadAppointments();
      }

      // Logout functionality
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = './login.html';
      });

      async function loadAppointments() {
        try {
          const response = await fetch('/api/appointments/my-appointments', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            displayAppointments(data.appointments);
          } else {
            showMessage('Failed to load appointments', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showMessage('Network error. Please try again.', 'error');
        }
      }

      function displayAppointments(appointments) {
        loadingMessage.style.display = 'none';
        
        if (appointments.length === 0) {
          noAppointments.style.display = 'block';
          return;
        }

        noAppointments.style.display = 'none';
        
        const appointmentsHTML = appointments.map(appointment => {
          const date = new Date(appointment.appointmentDate).toLocaleDateString();
          const timeSlotText = appointment.timeSlot || 'Time not specified';

          const statusColors = {
            'pending': '#ff9800',
            'confirmed': '#4caf50',
            'cancelled': '#f44336',
            'completed': '#2196f3'
          };

          return `
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="color: #10375c; margin: 0;">${appointment.service}</h4>
                <span style="background: ${statusColors[appointment.status]}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; text-transform: capitalize;">
                  ${appointment.status}
                </span>
              </div>
              <div style="color: #666; font-size: 14px;">
                <p><strong>Date:</strong> ${date}</p>
                <p><strong>Time:</strong> ${timeSlotText}</p>
                <p><strong>Name:</strong> ${appointment.fullName}</p>
                <p><strong>Phone:</strong> ${appointment.phone}</p>
                ${appointment.notes ? `<p><strong>Notes:</strong> ${appointment.notes}</p>` : ''}
              </div>
              ${appointment.status === 'pending' ? `
                <div style="margin-top: 15px;">
                  <button onclick="cancelAppointment('${appointment.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Cancel
                  </button>
                  <button onclick="editAppointment('${appointment.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    Edit
                  </button>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        appointmentsList.innerHTML = appointmentsHTML;
      }

      async function cancelAppointment(appointmentId) {
        if (!confirm('Are you sure you want to cancel this appointment?')) {
          return;
        }

        try {
          const response = await fetch(`/api/appointments/${appointmentId}/cancel`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            showMessage('Appointment cancelled successfully', 'success');
            loadAppointments(); // Reload the list
          } else {
            const data = await response.json();
            showMessage(data.message || 'Failed to cancel appointment', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showMessage('Network error. Please try again.', 'error');
        }
      }

      function editAppointment(appointmentId) {
        // For now, redirect to services page with a message
        showMessage('Edit functionality coming soon!', 'info');
      }

      function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        const colors = {
          'success': { bg: '#e8f5e8', color: '#2e7d32' },
          'error': { bg: '#ffebee', color: '#c62828' },
          'info': { bg: '#e3f2fd', color: '#1976d2' }
        };
        
        messageDiv.style.backgroundColor = colors[type].bg;
        messageDiv.style.color = colors[type].color;
        
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
    </script>
  </body>
</html> 
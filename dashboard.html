<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Shine Smile</title>
    <link rel="stylesheet" href="./assets/css/reset.css" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link rel="stylesheet" href="./assets/css/chat.css" />
  </head>
  <body class="header">
    <div class="container">
      <div class="header-top">
        <a href="./"
          ><img
            src="./assets/img/logo.svg"
            alt="shine smile"
            class="logo header__logo"
        /></a>
        <nav class="navbar">
          <ul class="navbar__list" id="navbar__list--pc">
            <li class="navbar__item">
              <a href="./index.html" class="navbar__link">Home</a>
            </li>
            <li class="navbar__item">
              <a href="./services.html" class="navbar__link">Services</a>
            </li>
            <li class="navbar__item">
              <a href="#!" class="navbar__link">About</a>
            </li>
            <li class="navbar__item">
              <a href="#!" class="navbar__link">Doctors</a>
            </li>
          </ul>
        </nav>
        <div class="header__action">
          <span id="userInfo" style="color: #fff; margin-right: 20px"></span>
          <button id="logoutBtn" class="btn header__action--sign-up">
            Logout
          </button>
        </div>
      </div>

      <div
        class="about-content"
        style="
          margin: 30px auto;
          min-width: 940px;
          padding: 40px 20px;
          background: #1a3a5d;
          border-radius: 20px;
        "
      >
        <h2
          class="section-heading"
          style="
            font-size: 3rem;
            text-align: center;
            margin-bottom: 40px;
            color: #fff;
          "
        >
          My Appointments
        </h2>

        <div
          id="loginMessage"
          style="
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
          "
        >
          Please <a href="./login.html" style="color: #2e80ce">login</a> to view
          your dashboard
        </div>

        <div id="dashboardContent" style="display: none; width: 900px;">
          <div
            style="
              background: #e8f5e8;
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 30px;
            "
          >
            <h3 style="color: #2e7d32; margin-bottom: 10px">Welcome back!</h3>
            <p id="userDetails" style="color: #10375c"></p>
          </div>

          <div style="margin-bottom: 30px">
            <h3 style="color: #10375c; margin-bottom: 20px">My Appointments</h3>
            <div
              id="appointmentsList"
              style="background: #fff; border-radius: 10px; padding: 20px"
            >
              <div id="loadingMessage" style="text-align: center; color: #666">
                Loading appointments...
              </div>
              <div
                id="noAppointments"
                style="display: none; text-align: center; color: #666"
              >
                No appointments found.
                <a href="./services.html" style="color: #2e80ce"
                  >Book your first appointment</a
                >
              </div>
            </div>
          </div>

          <div style="text-align: center">
            <a
              href="./services.html"
              class="btn"
              style="display: inline-block; margin: 0 10px"
            >
              Book New Appointment
            </a>
          </div>
        </div>

        <div
          id="message"
          style="
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
          "
        ></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "{}");
      const loginMessage = document.getElementById("loginMessage");
      const dashboardContent = document.getElementById("dashboardContent");
      const userInfo = document.getElementById("userInfo");
      const userDetails = document.getElementById("userDetails");
      const appointmentsList = document.getElementById("appointmentsList");
      const loadingMessage = document.getElementById("loadingMessage");
      const noAppointments = document.getElementById("noAppointments");
      const logoutBtn = document.getElementById("logoutBtn");
      const messageDiv = document.getElementById("message");

      // Check if user is logged in
      if (!token) {
        loginMessage.style.display = "block";
        dashboardContent.style.display = "none";
      } else {
        loginMessage.style.display = "none";
        dashboardContent.style.display = "block";

        // Display user info
        userInfo.textContent = `Welcome, ${
          user.fullName || user.username || "User"
        }`;
        userDetails.textContent = `Email: ${user.email || "N/A"}`;

        // Load appointments
        loadAppointments();
      }

      // Logout functionality
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "./login.html";
      });

      async function loadAppointments() {
        try {
          const response = await fetch(
            "http://localhost:5000/api/appointments/my-appointments",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            displayAppointments(data.appointments);
          } else {
            showMessage("Failed to load appointments", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showMessage("Network error. Please try again.", "error");
        }
      }

      function displayAppointments(appointments) {
        loadingMessage.style.display = "none";

        if (appointments.length === 0) {
          noAppointments.style.display = "block";
          return;
        }

        noAppointments.style.display = "none";

        const tableHeader = `
    <table class="appointments-table">
      <thead>
        <tr>
          <th>Service</th>
          <th>Date</th>
          <th>Time</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
  `;

        const tableBody = appointments
          .map((a) => {
            const date = new Date(a.appointmentDate).toLocaleDateString();
            const time = a.timeSlot || "N/A";
            const status = a.status || "pending";
            const cancelBtn =
              status === "pending"
                ? `<button class="cancel-btn" onclick="cancelAppointment('${a.id}')">Cancel</button>`
                : "";

            return `
        <tr>
          <td>${a.service}</td>
          <td>${date}</td>
          <td>${time}</td>
          <td>${a.fullName}</td>
          <td>${a.phone}</td>
          <td><span class="status status-${status}">${status}</span></td>
          <td>${cancelBtn}</td>
        </tr>
      `;
          })
          .join("");

        const tableFooter = `
      </tbody>
    </table>
  `;

        appointmentsList.innerHTML = tableHeader + tableBody + tableFooter;
      }

      async function cancelAppointment(appointmentId) {
        if (!confirm("Are you sure you want to cancel this appointment?")) {
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:5000/api/appointments/appointments/${appointmentId}/cancel`,
            {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.ok) {
            showMessage("Appointment cancelled successfully", "success");
            loadAppointments(); // Reload the list
          } else {
            const data = await response.json();
            showMessage(
              data.message || "Failed to cancel appointment",
              "error"
            );
          }
        } catch (error) {
          console.error("Error:", error);
          showMessage("Network error. Please try again.", "error");
        }
      }

      function editAppointment(appointmentId) {
        // For now, redirect to services page with a message
        showMessage("Edit functionality coming soon!", "info");
      }

      function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.style.display = "block";

        const colors = {
          success: { bg: "#e8f5e8", color: "#2e7d32" },
          error: { bg: "#ffebee", color: "#c62828" },
          info: { bg: "#e3f2fd", color: "#1976d2" },
        };

        messageDiv.style.backgroundColor = colors[type].bg;
        messageDiv.style.color = colors[type].color;

        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 5000);
      }
      
      // Real-time appointment updates
      function initRealTimeUpdates() {
        // Load Socket.IO client
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.7.4/socket.io.min.js';
        script.onload = () => {
          const socket = io('http://localhost:5000');
          
          socket.on('connect', () => {
            console.log('User connected to real-time updates');
            
            // Join as user
            const user = JSON.parse(localStorage.getItem("user") || "{}");
            socket.emit('join-chat', {
              name: user.fullName || 'User',
              email: user.email || '',
              isAdmin: false
            });
          });
          
          socket.on('appointment-update', (eventData) => {
            console.log('Real-time appointment update:', eventData);
            
            const { type, appointment, userId } = eventData;
            const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
            
            // Only show updates for current user's appointments or admin updates
            if (appointment.userId === currentUser.id || type === 'updated') {
              let notificationMessage = '';
              let notificationType = 'info';
              
              switch (type) {
                case 'updated':
                  notificationMessage = `Your appointment has been updated: ${appointment.service} - ${appointment.status}`;
                  notificationType = 'info';
                  break;
                case 'cancelled':
                  if (appointment.userId === currentUser.id) {
                    notificationMessage = `Your appointment has been cancelled: ${appointment.service}`;
                    notificationType = 'warning';
                  }
                  break;
                case 'deleted':
                  if (appointment.userId === currentUser.id) {
                    notificationMessage = `Your appointment has been deleted: ${appointment.service}`;
                    notificationType = 'error';
                  }
                  break;
              }
              
              // Show notification
              if (notificationMessage) {
                showRealTimeNotification(notificationMessage, notificationType);
              }
              
              // Refresh appointments list
              loadAppointments();
            }
          });
        };
        document.head.appendChild(script);
      }
      
      function showRealTimeNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: bold;
          z-index: 10000;
          max-width: 300px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          animation: slideInRight 0.3s ease-out;
        `;
        
        // Set background color based on type
        switch (type) {
          case 'success':
            notification.style.backgroundColor = '#4caf50';
            break;
          case 'warning':
            notification.style.backgroundColor = '#ff9800';
            break;
          case 'error':
            notification.style.backgroundColor = '#f44336';
            break;
          default:
            notification.style.backgroundColor = '#2196f3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove notification after 5 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 5000);
      }
      
      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      // Initialize real-time updates
      initRealTimeUpdates();
    </script>
    
    <!-- Chat Widget -->
    <script src="./assets/js/chat.js"></script>
  </body>
</html>
